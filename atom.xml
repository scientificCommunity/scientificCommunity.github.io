<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>穹柏</title>
  <icon>https://www.krivers.fun/icon.png</icon>
  <subtitle>疏影横斜水清浅，暗香浮动月黄昏</subtitle>
  <link href="https://www.krivers.fun/atom.xml" rel="self"/>
  
  <link href="https://www.krivers.fun/"/>
  <updated>2023-11-29T06:33:26.506Z</updated>
  <id>https://www.krivers.fun/</id>
  
  <author>
    <name>穹柏</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>k8s</title>
    <link href="https://www.krivers.fun/posts/655061ae/"/>
    <id>https://www.krivers.fun/posts/655061ae/</id>
    <published>2022-04-05T09:41:39.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>Mysql之浅析AUTO_INCREMENT</title>
    <link href="https://www.krivers.fun/posts/34050/"/>
    <id>https://www.krivers.fun/posts/34050/</id>
    <published>2022-02-09T09:25:09.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">AUTO_INCREMENT用于为表中的列设置一个自增序列，在非集群模式下，用它来为主键列自动生成值是一件很方便的事。并且，Mysql提供了一系列的锁机制来保证它的性能跟可靠性，通过这些锁机制，我们可以让它变得很高效。</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Mysql" scheme="https://www.krivers.fun/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>Mysql之浅析INSERT ON DUPLICATE</title>
    <link href="https://www.krivers.fun/posts/34049/"/>
    <id>https://www.krivers.fun/posts/34049/</id>
    <published>2022-01-04T06:00:00.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">往数据库中插入记录时，如果发生唯一索引值冲突，insert on duplicate允许进行进一步的crud操作。</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="Mysql" scheme="https://www.krivers.fun/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>杂谈之容器内访问宿主机docker命令</title>
    <link href="https://www.krivers.fun/posts/47873/"/>
    <id>https://www.krivers.fun/posts/47873/</id>
    <published>2021-09-20T00:42:56.000Z</published>
    <updated>2023-11-29T06:33:26.507Z</updated>
    
    
    <summary type="html">docker在被安装时会在/var/lib/docker.sock目录下创建unix domain socket...</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title>杂谈之树莓派挂载硬盘</title>
    <link href="https://www.krivers.fun/posts/4224/"/>
    <id>https://www.krivers.fun/posts/4224/</id>
    <published>2021-09-19T15:36:42.000Z</published>
    <updated>2023-11-29T06:33:26.507Z</updated>
    
    
    <summary type="html">挂载步骤...</summary>
    
    
    
    
    <category term="杂谈" scheme="https://www.krivers.fun/tags/%E6%9D%82%E8%B0%88/"/>
    
  </entry>
  
  <entry>
    <title>杂谈之非root用户运行docker命令</title>
    <link href="https://www.krivers.fun/posts/10743/"/>
    <id>https://www.krivers.fun/posts/10743/</id>
    <published>2021-09-19T15:36:42.000Z</published>
    <updated>2023-11-29T06:33:26.507Z</updated>
    
    
    <summary type="html">&lt;h1 id=&quot;步骤&quot;&gt;&lt;a href=&quot;#步骤&quot; class=&quot;headerlink&quot; title=&quot;步骤&quot;&gt;&lt;/a&gt;步骤&lt;/h1&gt;&lt;h2 id=&quot;1-将用户添加至docker组中&quot;&gt;&lt;a href=&quot;#1-将用户添加至docker组中&quot; class=&quot;headerlink&quot; title=&quot;1. 将用户添加至docker组中&quot;&gt;&lt;/a&gt;1. 将用户添加至docker组中&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;usermod -aG docker currUser&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;code&gt;docker&lt;/code&gt;命令本质上是通过访问(读写)&lt;code&gt;/var/run/docker.sock&lt;/code&gt;来完成与&lt;code&gt;docker&lt;/code&gt;的交互。&lt;code&gt;/var/run/docker.sock&lt;/code&gt;默认属于&lt;code&gt;docker&lt;/code&gt;组以及&lt;code&gt;root&lt;/code&gt;用户，所以，要想获得&lt;code&gt;docker&lt;/code&gt;命令执行权，需要将用户添加到&lt;code&gt;docker&lt;/code&gt;组中。&lt;br&gt;ps: 如果docker组不存在，则需先执行：&lt;code&gt;sudo groupadd docker&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;2-切换到docker组&quot;&gt;&lt;a href=&quot;#2-切换到docker组&quot; class=&quot;headerlink&quot; title=&quot;2. 切换到docker组&quot;&gt;&lt;/a&gt;2. 切换到docker组&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;newgrp docker&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-socket-option&quot;&gt;daemon-socket-option&lt;/a&gt;&lt;/p&gt;
</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title>踩坑日记之Gradle自定义JacocoReport跟Test task</title>
    <link href="https://www.krivers.fun/posts/60737/"/>
    <id>https://www.krivers.fun/posts/60737/</id>
    <published>2021-09-18T04:56:33.000Z</published>
    <updated>2023-11-29T06:33:26.507Z</updated>
    
    
    <summary type="html">最近新写了一个项目，为了更好的保证项目输出的质量，引入了单元测试覆盖率统计框架Jacoco...</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="踩坑" scheme="https://www.krivers.fun/tags/%E8%B8%A9%E5%9D%91/"/>
    
  </entry>
  
  <entry>
    <title>单元测试之浅析Mockito mock Kotlin Object类方法</title>
    <link href="https://www.krivers.fun/posts/48796/"/>
    <id>https://www.krivers.fun/posts/48796/</id>
    <published>2021-09-12T15:38:56.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">Kotlin里有一种object类型的类，它在使用上跟Java里的静态类很相似。事实上，它们编译后确实很相似，只不过Kotlin在语法层面上隐藏了一些实现细节，这些细节如果不清楚的话往往会引发一些意料之外的错误...</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="踩坑" scheme="https://www.krivers.fun/tags/%E8%B8%A9%E5%9D%91/"/>
    
  </entry>
  
  <entry>
    <title>踩坑日记之Springfox+Kotlin lateinit引发NullPointException</title>
    <link href="https://www.krivers.fun/posts/4a9faf5f/"/>
    <id>https://www.krivers.fun/posts/4a9faf5f/</id>
    <published>2021-09-03T05:24:47.000Z</published>
    <updated>2023-11-29T06:33:26.507Z</updated>
    
    
    <summary type="html">在定义完接口后发现Springfox初始化swagger时报了空指针，导致swagger api doc无法加载</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title>Auto DevOps之gitlab CI/CD</title>
    <link href="https://www.krivers.fun/posts/7dfe0119/"/>
    <id>https://www.krivers.fun/posts/7dfe0119/</id>
    <published>2021-08-01T16:12:36.000Z</published>
    <updated>2023-11-29T06:33:26.505Z</updated>
    
    
    <summary type="html">CI/CD是什么，如何应用gitlab CI/CD到我们的项目中？</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="运维" scheme="https://www.krivers.fun/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>GC调优之避免临时对象进入老年代思路浅析</title>
    <link href="https://www.krivers.fun/posts/8ccc4590/"/>
    <id>https://www.krivers.fun/posts/8ccc4590/</id>
    <published>2021-06-09T10:25:00.000Z</published>
    <updated>2023-11-29T06:33:26.505Z</updated>
    
    
    <summary type="html">&lt;h3 id=&quot;什么是临时对象？&quot;&gt;&lt;a href=&quot;#什么是临时对象？&quot; class=&quot;headerlink&quot; title=&quot;什么是临时对象？&quot;&gt;&lt;/a&gt;什么是临时对象？&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;顾名思义，临时对象就是不能长期存活的对象，那么，怎么判断这个临时性呢？&lt;/li&gt;
&lt;li&gt;从代码层来看，这个临时对象通常是指一些局部变量&lt;/li&gt;
&lt;li&gt;对象有个属性叫分代年龄。分代年龄的值代表着这个对象经历的gc次数。在survivor区域不溢出的情况下经过有限次（默认是15次，具体要看系统实例情况，比如如果系统里年轻代大部分对象的分代年龄超过5就不太可能被回收，就可以认为分代年龄小于5的对象为临时对象）minor gc就能被回收的对象&lt;h3 id=&quot;临时对象进入看年代有什么后果&quot;&gt;&lt;a href=&quot;#临时对象进入看年代有什么后果&quot; class=&quot;headerlink&quot; title=&quot;临时对象进入看年代有什么后果&quot;&gt;&lt;/a&gt;临时对象进入看年代有什么后果&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;顾名思义，老年代是用来存放那些分代年龄较大的对象（能够长时间存活）。临时对象进入老年代，意味着老年代浪费了部分内存空间来存储无用的数据，最终导致full gc会更频繁的发生。而对老年代进行垃圾收集的成本相对minor gc好很多，有stop the world的过程，同时gc线程也会占用cpu资源。这些最终也导致了系统性能降低&lt;h3 id=&quot;怎么避免临时对象进入老年代&quot;&gt;&lt;a href=&quot;#怎么避免临时对象进入老年代&quot; class=&quot;headerlink&quot; title=&quot;怎么避免临时对象进入老年代&quot;&gt;&lt;/a&gt;怎么避免临时对象进入老年代&lt;/h3&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;调整对象进入老年代的分代年龄的阈值&lt;/li&gt;
&lt;li&gt;避免survivor区域的溢出（溢出会导致所有年轻代的对象直接进入老年代）&lt;/li&gt;
&lt;li&gt; 上述两种思路需要根据系统实际负载来调整分代年龄阈值跟年轻代各区域的大小&lt;/li&gt;
&lt;/ol&gt;
</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="jvm" scheme="https://www.krivers.fun/tags/jvm/"/>
    
    <category term="调优" scheme="https://www.krivers.fun/tags/%E8%B0%83%E4%BC%98/"/>
    
  </entry>
  
  <entry>
    <title>随笔之Http为什么经常被吐槽慢？</title>
    <link href="https://www.krivers.fun/posts/bb46fe66/"/>
    <id>https://www.krivers.fun/posts/bb46fe66/</id>
    <published>2021-06-03T12:18:21.000Z</published>
    <updated>2023-11-29T06:33:26.507Z</updated>
    
    
    <summary type="html">&lt;p&gt;http1因为没有对请求跟响应加上唯一标识（历史包袱），为了保证请求跟响应的一一对应，同一个连接上请求的发送必须在上一个请求完成之后（http层面的hol blocking问题）。所以，只要有并发，必然就会有阻塞，这个阻塞会随着请求并发的程度跟网络环境逐渐放大，这也是http1效率低（慢）的主要原因。像1.0的keep-alive出现之前，每次请求都需要重新建立连接，效率更是可怕的低。&lt;br&gt;不过http2在frame（应用层）层面加了一个streamId，使得不同请求的数据可以在同一条连接上混合传输，使得并发的效率得到大幅提升&lt;/p&gt;
</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="网络通信" scheme="https://www.krivers.fun/tags/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/"/>
    
    <category term="随笔" scheme="https://www.krivers.fun/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>Vertx实战之如何追踪异步函数调用</title>
    <link href="https://www.krivers.fun/posts/6a250a7b/"/>
    <id>https://www.krivers.fun/posts/6a250a7b/</id>
    <published>2021-06-03T11:31:41.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">&lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;日常开发中我们经常需要处理各种系统问题，而这些系统问题通常由一些非预期的因素引起（比如非预期的输入，内存不够，网络波动等）。此时就需要知道&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;本次系统问题影响了谁？&lt;/li&gt;
&lt;li&gt;如果本次系统问题是因为非预期的输入而导致的，那么这个非预期的输入是什么？&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;上述两点在同步编程里可以通过全局try-catch来实现。但在异步编程里该怎么办呢？&lt;/p&gt;
&lt;hr&gt;
&lt;h1 id=&quot;思路&quot;&gt;&lt;a href=&quot;#思路&quot; class=&quot;headerlink&quot; title=&quot;思路&quot;&gt;&lt;/a&gt;思路&lt;/h1&gt;&lt;p&gt;我的想法是绑定一个唯一id到一次完整的请求调用中（这个完整取决于我们想要监控的范围），无论程序执行到何处，我们总能拿到与请求一一对应的&lt;code&gt;调用上下文&lt;/code&gt;的id。&lt;/p&gt;
&lt;p&gt;  我将分两种场景进行讨论。一种是同步或基于jut下的线程池类进行异步调用的应用程序（如基于spring5之前的应用程序）。另外一种基于vertx（底层基于netty）的应用程序。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id=&quot;技术栈&quot;&gt;&lt;a href=&quot;#技术栈&quot; class=&quot;headerlink&quot; title=&quot;技术栈&quot;&gt;&lt;/a&gt;技术栈&lt;/h2&gt;</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="jvm" scheme="https://www.krivers.fun/tags/jvm/"/>
    
    <category term="实战" scheme="https://www.krivers.fun/tags/%E5%AE%9E%E6%88%98/"/>
    
    <category term="Vertx" scheme="https://www.krivers.fun/tags/Vertx/"/>
    
  </entry>
  
  <entry>
    <title>单元测试之kotlin mockk用法浅析</title>
    <link href="https://www.krivers.fun/posts/a1887a80/"/>
    <id>https://www.krivers.fun/posts/a1887a80/</id>
    <published>2020-11-18T09:59:26.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">如何使用kotlin mockk?...</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="浅析" scheme="https://www.krivers.fun/tags/%E6%B5%85%E6%9E%90/"/>
    
    <category term="unit test" scheme="https://www.krivers.fun/tags/unit-test/"/>
    
  </entry>
  
  <entry>
    <title>vert.x源码浅析之redis集成</title>
    <link href="https://www.krivers.fun/posts/4fc0a6f7/"/>
    <id>https://www.krivers.fun/posts/4fc0a6f7/</id>
    <published>2020-11-10T06:58:19.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">vert.x是一个全异步框架，通过内部的event bus跟event loop做到了处处皆异步...</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="源码" scheme="https://www.krivers.fun/tags/%E6%BA%90%E7%A0%81/"/>
    
    <category term="浅析" scheme="https://www.krivers.fun/tags/%E6%B5%85%E6%9E%90/"/>
    
    <category term="vertx" scheme="https://www.krivers.fun/tags/vertx/"/>
    
  </entry>
  
  <entry>
    <title>Spring源码浅析之@Autowired如何解决循环依赖</title>
    <link href="https://www.krivers.fun/posts/f0ea53d7/"/>
    <id>https://www.krivers.fun/posts/f0ea53d7/</id>
    <published>2020-10-22T06:42:21.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">通过Autowired注解，当spring ioc容器初始化时会帮我们从容器中拿到对应的实例进行注入</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="技术" scheme="https://www.krivers.fun/tags/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="源码" scheme="https://www.krivers.fun/tags/%E6%BA%90%E7%A0%81/"/>
    
    <category term="spring" scheme="https://www.krivers.fun/tags/spring/"/>
    
    <category term="浅析" scheme="https://www.krivers.fun/tags/%E6%B5%85%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Spring源码浅析之事物管理</title>
    <link href="https://www.krivers.fun/posts/992afad8/"/>
    <id>https://www.krivers.fun/posts/992afad8/</id>
    <published>2020-07-16T10:13:20.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">&lt;h1 id=&quot;思考&quot;&gt;&lt;a href=&quot;#思考&quot; class=&quot;headerlink&quot; title=&quot;思考&quot;&gt;&lt;/a&gt;思考&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt; &lt;strong&gt;spring是怎样帮助我们进行事务管理的&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt; &lt;strong&gt;spring是如何实现事务的传播的&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;概览&quot;&gt;&lt;a href=&quot;#概览&quot; class=&quot;headerlink&quot; title=&quot;概览&quot;&gt;&lt;/a&gt;概览&lt;/h1&gt;&lt;p&gt;spring声明式事务需要aop的支持，在spring容器初始化的时候，会将一个TransactionInterceptor的实例注入到所有方法上加了@Transactional注解的bean的代理对象的advisor数组中，当我们执行事务方法时，就会去执行TransactionInterceptor.invoke方法进行事务处理&lt;/p&gt;
&lt;h1 id=&quot;TransactionInterceptor&quot;&gt;&lt;a href=&quot;#TransactionInterceptor&quot; class=&quot;headerlink&quot; title=&quot;TransactionInterceptor&quot;&gt;&lt;/a&gt;TransactionInterceptor&lt;/h1&gt;&lt;h2 id=&quot;注入TransactionInterceptor的过程参考&quot;&gt;&lt;a href=&quot;#注入TransactionInterceptor的过程参考&quot; class=&quot;headerlink&quot; title=&quot;注入TransactionInterceptor的过程参考&quot;&gt;&lt;/a&gt;注入TransactionInterceptor的过程参考&lt;/h2&gt;&lt;p&gt;1. 首先初始化所有Advisor，这个过程会把容器中实现了advisor接口的beanDefinition对应的类实例化并加入到一个AdvisedSupport对象中，最后会注入到代理对象&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;AbstractAutoProxyCreator.postProcessBeforeInstantiation()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ---&amp;gt;AspectJAwareAdvisorAutoProxyCreator.shouldSkip()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       ---&amp;gt;AspectJAwareAdvisorAutoProxyCreator.findCandidateAdvisors() &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2. 代理bean&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;AbstractAutoProxyCreator.postProcessAfterInitialization()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     --&amp;gt;AbstractAutoProxyCreator.wrapIfNecessary()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;comment&quot;&gt;//这里面会去选择使用jdk或者cglib进行代理对象的创建&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         --&amp;gt;AbstractAutoProxyCreator.createProxy()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="源码" scheme="https://www.krivers.fun/tags/%E6%BA%90%E7%A0%81/"/>
    
    <category term="spring" scheme="https://www.krivers.fun/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>seata源码分析之如何控制下游服务的提交与回滚</title>
    <link href="https://www.krivers.fun/posts/940a39da/"/>
    <id>https://www.krivers.fun/posts/940a39da/</id>
    <published>2018-07-12T04:07:06.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">&lt;p&gt;概览&lt;/p&gt;
&lt;h3 id=&quot;seata-client跟维持了一个连接，监听server端的消息，根据接到的消息判断是提交还是回滚。&quot;&gt;&lt;a href=&quot;#seata-client跟维持了一个连接，监听server端的消息，根据接到的消息判断是提交还是回滚。&quot; class=&quot;headerlink&quot; title=&quot;seata client跟维持了一个连接，监听server端的消息，根据接到的消息判断是提交还是回滚。&quot;&gt;&lt;/a&gt;seata client跟维持了一个连接，监听server端的消息，根据接到的消息判断是提交还是回滚。&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;客户端建立流程：&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;GlobalTransactionScanner.afterPropertiesSet()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   GlobalTransactionScanner.initClient()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      TMClient.init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        TmRpcClient.getInstance&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             new TmRpcClient&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                new RpcClientBootstrap&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;a href=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot;&gt;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;RpcClientBootstrap内部包装了netty的Bootstrap，其中会向Bootstrap绑定一个ClientHandler用来处理seata server返回来的消息&lt;/p&gt;
&lt;p&gt;，最终通过Bootstrap建立与server端的连接。&lt;/p&gt;
&lt;p&gt;接下来就是核心处理逻辑了，先看看类图&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://img-blog.csdnimg.cn/20200712110624216.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjaWVudGlmaWNDb21tdW5pdHk=,size_16,color_FFFFFF,t_70&quot; alt=&quot;https://img-blog.csdnimg.cn/20200712110624216.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjaWVudGlmaWNDb21tdW5pdHk=,size_16,color_FFFFFF,t_70&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot;&gt;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="源码" scheme="https://www.krivers.fun/tags/%E6%BA%90%E7%A0%81/"/>
    
    <category term="seata" scheme="https://www.krivers.fun/tags/seata/"/>
    
  </entry>
  
  <entry>
    <title>seata源码分析之全局事务的开启跟xid的传递</title>
    <link href="https://www.krivers.fun/posts/b310611e/"/>
    <id>https://www.krivers.fun/posts/b310611e/</id>
    <published>2018-02-10T10:25:17.000Z</published>
    <updated>2023-11-29T06:33:26.506Z</updated>
    
    
    <summary type="html">&lt;h1 id=&quot;概览&quot;&gt;&lt;a href=&quot;#概览&quot; class=&quot;headerlink&quot; title=&quot;概览&quot;&gt;&lt;/a&gt;概览&lt;/h1&gt;&lt;h3 id=&quot;首先我们通过-GlobalTransactional这个注解开启一个全局事务，而GlobalTransactionScanner-wrapIfNecessary-会为所有方法上加了这个注解的bean注入一个包装了GlobalTransactionalInterceptor实例的advisor，然后返回一个代理对象。GlobalTransactionalInterceptor会在该bean的方法调用前进行拦截，判断是否开启全局事务&quot;&gt;&lt;a href=&quot;#首先我们通过-GlobalTransactional这个注解开启一个全局事务，而GlobalTransactionScanner-wrapIfNecessary-会为所有方法上加了这个注解的bean注入一个包装了GlobalTransactionalInterceptor实例的advisor，然后返回一个代理对象。GlobalTransactionalInterceptor会在该bean的方法调用前进行拦截，判断是否开启全局事务&quot; class=&quot;headerlink&quot; title=&quot;首先我们通过@GlobalTransactional这个注解开启一个全局事务，而GlobalTransactionScanner.wrapIfNecessary()会为所有方法上加了这个注解的bean注入一个包装了GlobalTransactionalInterceptor实例的advisor，然后返回一个代理对象。GlobalTransactionalInterceptor会在该bean的方法调用前进行拦截，判断是否开启全局事务&quot;&gt;&lt;/a&gt;首先我们通过@GlobalTransactional这个注解开启一个全局事务，而GlobalTransactionScanner.wrapIfNecessary()会为所有方法上加了这个注解的bean注入一个包装了GlobalTransactionalInterceptor实例的advisor，然后返回一个代理对象。GlobalTransactionalInterceptor会在该bean的方法调用前进行拦截，判断是否开启全局事务&lt;/h3&gt;&lt;p&gt;上源码，关键位置我打了注释&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;@Override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    //判断全局事务是否启用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if (disableGlobalTransaction) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        return bean;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        synchronized (PROXYED_SET) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            if (PROXYED_SET.contains(beanName)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                return bean;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            interceptor = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            //check TCC proxy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            if (TCCBeanParserUtils.isTccAutoProxy(bean, beanName, applicationContext)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                //TCC interceptor, proxy bean of sofa:reference/dubbo:reference, and LocalTCC&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                interceptor = new TccActionInterceptor(TCCBeanParserUtils.getRemotingDesc(beanName));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Class&amp;lt;?&amp;gt; serviceInterface = SpringProxyUtils.findTargetClass(bean);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Class&amp;lt;?&amp;gt;[] interfacesIfJdk = SpringProxyUtils.findInterfaces(bean);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                //判断bean里的方法上有没有@GlobalTransactional注解&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                if (!existsAnnotation(new Class[]&amp;#123;serviceInterface&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;amp;&amp;amp; !existsAnnotation(interfacesIfJdk)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    return bean;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                if (interceptor == null) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    //初始化Interceptor,后面会注入代理对象&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    interceptor = new GlobalTransactionalInterceptor(failureHandlerHook);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    ConfigurationFactory.getInstance().addConfigListener(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION, (ConfigurationChangeListener) interceptor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            //判断当前bean是否已被aop代理过，比如说方法上加了@Transactional就会被spring代理&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            //如果没有被代理，调用父类的模板方法进行代理，advisor通过被重写的&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            //getAdvicesAndAdvisorsForBean返回上面的interceptor进行包装&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            if (!AopUtils.isAopProxy(bean)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                bean = super.wrapIfNecessary(bean, beanName, cacheKey);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                AdvisedSupport advised = SpringProxyUtils.getAdvisedSupport(bean);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                //把GlobalTransactionalInterceptor包装成advisor&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Advisor[] advisor = buildAdvisors(beanName, getAdvicesAndAdvisorsForBean(null, null, null));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                for (Advisor avr : advisor) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    advised.addAdvisor(0, avr);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            PROXYED_SET.add(beanName);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            return bean;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; catch (Exception exx) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        throw new RuntimeException(exx);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@Override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;protected Object[] getAdvicesAndAdvisorsForBean(Class beanClass, String beanName,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  TargetSource customTargetSource) throws BeansException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    //返回interceptor[]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return new Object[]&amp;#123;interceptor&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@Override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    public void afterPropertiesSet() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        if (disableGlobalTransaction) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            if (LOGGER.isInfoEnabled()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                LOGGER.info(&amp;quot;Global transaction is disabled.&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            return;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        //使用netty初始化seata client，建立到server端的连接&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        initClient();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;a href=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot;&gt;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这里可以看出来，只要我们在方法上加了@GlobalTranscational注解，对应的bean就会被seata进行代理，同时重写了afterPropertiesSet，在bean初始化完毕后会进行调用，这个client就是用来跟server端通信的，包括后面会说到的下游服务的事务提交与回滚都与这个有关&lt;/p&gt;
&lt;p&gt;GlobalTransactionalInterceptor重写了MethodInterceptor的invoke()方法，在spring执行通知代理对象的通知方法时，最终会调用到这个invoke()&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;@Override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;public Object invoke(final MethodInvocation methodInvocation) throws Throwable &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Class&amp;lt;?&amp;gt; targetClass = methodInvocation.getThis() != null ?AopUtils.getTargetClass(methodInvocation.getThis()) : null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        //如果全局事务可用并且方法上加了@GlobalTransactional注解&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        if (!disable &amp;amp;&amp;amp; globalTransactionalAnnotation != null) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            //处理全局事务&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; else if (!disable &amp;amp;&amp;amp; globalLockAnnotation != null) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            return handleGlobalLock(methodInvocation);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            return methodInvocation.proceed();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;a href=&quot;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&quot;&gt;data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这里就会然后调用handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="https://www.krivers.fun/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
    <category term="源码" scheme="https://www.krivers.fun/tags/%E6%BA%90%E7%A0%81/"/>
    
    <category term="seata" scheme="https://www.krivers.fun/tags/seata/"/>
    
  </entry>
  
</feed>
